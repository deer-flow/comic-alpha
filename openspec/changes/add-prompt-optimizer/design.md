# 设计文档: Prompt 优化功能

## Context
当前系统允许用户输入简单的提示词来生成漫画分镜,但许多用户不清楚如何编写有效的提示词。添加 AI 驱动的 prompt 优化功能可以帮助用户将简单想法扩展为详细、结构化的提示词,提升生成质量。

约束条件:
- 必须支持现有的双 API 架构(Google Gemini + OpenAI 可选)
- 需要保持与现有代码风格和架构一致
- 优化过程需要快速响应(目标 < 5 秒)
- 必须支持中英文国际化

## Goals / Non-Goals

### Goals
- 提供一键优化功能,将简单提示词扩展为详细分镜描述
- 保持现有 API 架构(优先使用 Google Gemini,可选 OpenAI)
- 提供良好的用户体验(加载状态、错误处理)
- 支持中英文界面

### Non-Goals
- 不实现撤销/历史记录功能(未来可扩展)
- 不实现多轮对话式优化
- 不实现批量优化功能
- 不修改现有的分镜生成逻辑

## Decisions

### 决策 1: API 架构设计
**选择**: 创建独立的 `/api/optimize-prompt` 端点

**理由**:
- 遵循现有的 RESTful API 设计模式
- 与 `/api/generate` 端点保持一致的架构
- 便于未来扩展(如批量优化、历史记录)

**备选方案**:
- 将优化逻辑整合到 `/api/generate` 端点中 - 被拒绝,因为会增加端点复杂度,违反单一职责原则

### 决策 2: 优化策略
**选择**: 使用 AI 模型进行 prompt 扩展和改进

**优化提示词策略**:
```
系统提示词(system prompt):
- 理解用户的简单想法
- 扩展为适合漫画分镜的详细描述
- 添加视觉元素、角色细节、场景描述
- 保持故事连贯性和可视化
- 输出适合多页分镜的结构化描述

输出格式:
- 简洁但详细的单段文字
- 包含关键视觉元素
- 明确故事结构和节奏
```

**理由**:
- AI 模型擅长理解语义并进行扩展
- 可以根据漫画风格和语言进行定制化优化
- 灵活性高,易于调整优化策略

### 决策 3: 前端按钮位置
**选择**: 将优化按钮放置在 prompt 输入框右侧,作为辅助功能按钮

**理由**:
- 用户输入 prompt 时,优化按钮在视觉上自然关联
- 不影响主要的"Run"按钮
- 魔法棒图标清晰表达"优化/增强"的语义

**UI 设计**:
```
[Prompt 输入框]  [魔法棒按钮] [Run 按钮]
```

### 决策 4: 响应处理
**选择**: 优化后直接替换输入框内容

**理由**:
- 简单直接,用户体验流畅
- 用户可以手动编辑优化后的内容
- 浏览器的 Ctrl+Z 可以恢复原内容(textarea 原生支持)

**备选方案**:
- 弹出对话框显示优化结果,用户选择是否应用 - 被拒绝,增加交互步骤,影响效率

### 决策 5: 错误处理
**选择**: 显示友好的错误提示,不中断用户操作

**错误场景**:
- API Key 未配置: 提示用户配置 Google API Key 或 OpenAI API Key
- API 调用失败: 显示错误信息,保留原始输入
- 网络超时: 提示用户稍后重试

## Risks / Trade-offs

### 风险 1: API 成本增加
- **描述**: 每次优化都会调用 AI API,增加使用成本
- **缓解措施**: 
  - 优化调用使用较小的模型(如 gemini-flash-preview)
  - 添加客户端限流(可选,未来扩展)

### 风险 2: 优化质量不稳定
- **描述**: AI 优化结果可能不符合用户期望
- **缓解措施**:
  - 精心设计 system prompt,明确优化方向
  - 允许用户手动编辑优化结果
  - 未来可添加"重新优化"功能

### Trade-off: 简单性 vs 功能丰富性
- **选择**: 优先实现简单的一键优化功能
- **代价**: 不支持撤销历史、多轮优化等高级功能
- **理由**: 遵循"先简单实现,后逐步增强"的原则,降低初始复杂度

## Migration Plan
无需迁移,这是新增功能。

部署步骤:
1. 部署后端代码(新增 API 端点)
2. 部署前端代码(新增 UI 按钮)
3. 验证功能正常工作
4. 如有问题,可以通过前端隐藏按钮快速回滚

## Open Questions
无
